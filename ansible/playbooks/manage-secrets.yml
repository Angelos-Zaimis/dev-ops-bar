---
- name: Manage SSH keys and secrets
  hosts: all
  
  vars_files:
    - ../vault/secrets.yml
  
  tasks:
    - name: Ensure .ssh directory exists
      file:
        path: "{{ ansible_env.HOME }}/.ssh"
        state: directory
        mode: '0700'
    
    - name: Deploy SSH private key
      copy:
        content: "{{ vault_ssh_private_key }}"
        dest: "{{ ssh_private_key_path }}"
        mode: '0600'
        owner: "{{ deployment_user }}"
      when: vault_ssh_private_key is defined
      no_log: true
    
    - name: Deploy SSH public key
      copy:
        content: "{{ vault_ssh_public_key }}"
        dest: "{{ ssh_public_key_path }}"
        mode: '0644'
        owner: "{{ deployment_user }}"
      when: vault_ssh_public_key is defined
    
    - name: Add SSH key to authorized_keys
      authorized_key:
        user: "{{ deployment_user }}"
        key: "{{ vault_ssh_public_key }}"
        state: present
      when: vault_ssh_public_key is defined
    
    - name: Create secure directory for credentials
      file:
        path: "{{ project_path }}/.credentials"
        state: directory
        mode: '0700'
        owner: "{{ deployment_user }}"
    
    - name: Deploy database credentials
      template:
        src: ../templates/db-credentials.j2
        dest: "{{ project_path }}/.credentials/db-credentials"
        mode: '0600'
        owner: "{{ deployment_user }}"
      no_log: true
    
    - name: Set strict file permissions on sensitive files
      file:
        path: "{{ item }}"
        mode: '0600'
        owner: "{{ deployment_user }}"
      loop:
        - "{{ project_path }}/.env"
        - "{{ ssh_private_key_path }}"
      when: item is exists

